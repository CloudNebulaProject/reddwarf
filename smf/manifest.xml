<?xml version="1.0"?>
<!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1">
<!--
    SMF service manifest for reddwarf — a Kubernetes-compatible control plane
    for illumos zones.

    Import:   svccfg import /opt/reddwarf/lib/svc/manifest/reddwarf.xml
    Enable:   svcadm enable svc:/system/reddwarf:default
    Logs:     svcs -L svc:/system/reddwarf:default
-->
<service_bundle type="manifest" name="reddwarf">

  <service name="system/reddwarf" type="service" version="1">

    <create_default_instance enabled="false" />

    <!-- Long-running daemon -->
    <single_instance />

    <dependency name="filesystem"
                grouping="require_all"
                restart_on="error"
                type="service">
      <service_fmri value="svc:/system/filesystem/local" />
    </dependency>

    <dependency name="loopback"
                grouping="require_all"
                restart_on="error"
                type="service">
      <service_fmri value="svc:/network/loopback" />
    </dependency>

    <dependency name="physical-network"
                grouping="optional_all"
                restart_on="error"
                type="service">
      <service_fmri value="svc:/network/physical" />
    </dependency>

    <exec_method type="method"
                 name="start"
                 exec="/opt/reddwarf/lib/svc/method/reddwarf start"
                 timeout_seconds="60">
      <method_context>
        <method_credential user="root" group="root" />
      </method_context>
    </exec_method>

    <exec_method type="method"
                 name="stop"
                 exec=":kill -TERM"
                 timeout_seconds="30" />

    <exec_method type="method"
                 name="refresh"
                 exec=":true"
                 timeout_seconds="10" />

    <property_group name="startd" type="framework">
      <propval name="duration" type="astring" value="child" />
      <propval name="ignore_error" type="astring" value="core,signal" />
    </property_group>

    <property_group name="application" type="application">
      <propval name="node_name"      type="astring" value="" />
      <propval name="listen_addr"    type="astring" value="0.0.0.0:6443" />
      <propval name="data_dir"       type="astring" value="/var/lib/reddwarf/reddwarf.redb" />
      <propval name="storage_pool"   type="astring" value="rpool" />
      <propval name="pod_cidr"       type="astring" value="10.88.0.0/16" />
      <propval name="etherstub_name" type="astring" value="reddwarf0" />
      <propval name="tls_enabled"    type="boolean" value="false" />
      <propval name="tls_cert"       type="astring" value="" />
      <propval name="tls_key"        type="astring" value="" />
    </property_group>

    <stability value="Evolving" />

    <template>
      <common_name>
        <loctext xml:lang="C">Reddwarf Kubernetes Control Plane</loctext>
      </common_name>
      <description>
        <loctext xml:lang="C">
          Reddwarf node agent — runs the API server, scheduler,
          pod controller, and node heartbeat as a single daemon
          managing illumos zones as Kubernetes pods.
        </loctext>
      </description>
    </template>

  </service>

</service_bundle>
